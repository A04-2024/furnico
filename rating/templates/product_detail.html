{% extends 'base.html' %}

{% block content %}
<div class="product-detail">
    <h1>{{ product.name }}</h1>
    <p>{{ product.description }}</p>
    
    <h3>Ratings</h3>
    <ul id="ratingsList">
        {% for rating in ratings %}
            <li>
                <strong>{{ rating.user.username }}:</strong> 
                {{ rating.rating }}/5 
                <p>{{ rating.comment }}</p>
            </li>
        {% empty %}
            <li>No ratings yet.</li>
        {% endfor %}
    </ul>

    <h3>Submit Your Rating</h3>
    <form id="ratingForm" method="POST">
        <label for="rating">Rating:</label>
        <input type="number" name="rating" min="1" max="5" required>
        <label for="comment">Comment:</label>
        <textarea name="comment" rows="4" required></textarea>
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <button type="submit">Submit</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ratingForm = document.getElementById('ratingForm');

        ratingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("{% url 'rating:add_rating_ajax' %}", {
                method: "POST",
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the ratings section without refreshing the page
                    const ratingsList = document.getElementById('ratingsList');
                    const newRating = `
                        <li>
                            <strong>{{ user.username }}:</strong> 
                            ${formData.get('rating')}/5 
                            <p>${formData.get('comment')}</p>
                        </li>`;
                    ratingsList.insertAdjacentHTML('beforeend', newRating);
                    ratingForm.reset();
                } else {
                    console.log(data.errors);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
</script>

{% endblock %}
